<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ“· äºŒç¶­ç¢¼æƒæåŠè³‡æ–™ç®¡ç†</title>
  <script src="https://unpkg.com/html5-qrcode" defer></script>
  <script src="https://code.jquery.com/jquery-3.7.0.min.js" defer></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js" defer></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background:#f5f5f5; padding:20px; }
    nav button { margin:5px; padding:8px 16px; border:none; border-radius:6px; background:#4CAF50; color:white; cursor:pointer; }
    nav button:hover { background:#45a049; }
    #reader, #readerQuery { max-width:350px; margin:auto; }
    #result, #latestRecord { background:#e0ffe0; margin-top:20px; padding:10px; border-radius:8px; white-space:pre-line; }
    .tag-panel { margin-top:15px; }
    .tag-input { margin-bottom:10px; }
    .upload-btn { margin-top:10px; padding:10px 20px; background:#2196F3; color:white; border:none; border-radius:6px; cursor:pointer; }
  </style>
</head>
<body>
  <h2>ğŸ“¸ äºŒç¶­ç¢¼æƒæåŠè³‡æ–™ç®¡ç†</h2>
  <nav>
    <button onclick="switchMode('scan')">æƒç¢¼ä¸Šå‚³</button>
    <button onclick="switchMode('query')">æƒç¢¼æŸ¥è©¢</button>
  </nav>

  <div id="scanSection">
    <div id="reader"></div>
    <div id="tagPanel" class="tag-panel">è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</div>
    <div>
      <label>å‚™è¨»ï¼š</label>
      <input type="text" id="globalNote" placeholder="è¼¸å…¥å‚™è¨»" style="width:80%; padding:5px;">
    </div>
    <button class="upload-btn" onclick="uploadData()">ğŸ“¤ ä¸Šå‚³è³‡æ–™</button>
    <div id="result">æƒæçµæœæœƒé¡¯ç¤ºåœ¨é€™è£¡</div>
    <div id="latestRecord">ä¸Šæ¬¡ç´€éŒ„æœƒé¡¯ç¤ºåœ¨é€™è£¡</div>
    <div id="loadingText"></div>
  </div>

  <div id="querySection" style="display:none;">
    <div id="readerQuery"></div>
    <div id="queryTable">è«‹æƒç¢¼å¾ŒæŸ¥è©¢</div>
    <div id="queryLoading"></div>
  </div>

<script>
let lastScanned = "";
let currentMode = "scan";
const scriptUrl = "https://script.google.com/macros/s/AKfycbyN49RSqSW6T4hroGFgCd0l-ql0WPl8rAIwy3hLRCtR2kbytEcaT7V_Dqik05grx_J5/exec";
let tagData = {};

function loadTags() {
  fetch(`${scriptUrl}?action=ItemList`)
    .then(res => res.json())
    .then(result => {
      if (result.status === "success" && Array.isArray(result.data)) {
        result.data.forEach(row => {
          const tag = row[0]?.trim();
          if (tag) tagData[tag] = true;
        });
        renderInputFields();
      } else {
        document.getElementById("tagPanel").innerText = "âš ï¸ è³‡æ–™æ ¼å¼éŒ¯èª¤";
      }
    })
    .catch(err => {
      console.error("è®€å–ItemListå¤±æ•—", err);
      document.getElementById("tagPanel").innerText = "âš ï¸ ç„¡æ³•è®€å–æ¨™ç±¤è³‡æ–™";
    });
}

function renderInputFields() {
  const panel = document.getElementById("tagPanel");
  panel.innerHTML = "";
  Object.keys(tagData).forEach(tag => {
    const div = document.createElement("div");
    div.className = "tag-input";
    div.innerHTML = `
      <label>${tag}ï¼š</label>
      <input type="text" id="input-${tag}" placeholder="è«‹è¼¸å…¥${tag}" style="padding:5px; width:70%;">
    `;
    panel.appendChild(div);
  });
}

function uploadData() {
  if (!lastScanned) {
    alert("âš ï¸ è«‹å…ˆæƒæä¸€å€‹ QRCodeï¼");
    return;
  }

  let noteParts = [];
  Object.keys(tagData).forEach(tag => {
    const value = document.getElementById(`input-${tag}`)?.value?.trim();
    if (value) noteParts.push(`${tag}:${value}`);
  });

  const extraNote = document.getElementById("globalNote").value?.trim();
  const finalNote = noteParts.join(", ") + (noteParts.length && extraNote ? ", " : "") + extraNote;

  document.getElementById("loadingText").innerText = "â¬†ï¸ æ­£åœ¨ä¸Šå‚³...";

  fetch(`${scriptUrl}?action=WriteData&text=${encodeURIComponent(lastScanned)}&note=${encodeURIComponent(finalNote)}`)
    .then(res => res.text())
    .then(result => {
      document.getElementById("loadingText").innerText = `âœ… ä¸Šå‚³æˆåŠŸï¼š${result}`;
      lastScanned = "";
    })
    .catch(err => {
      document.getElementById("loadingText").innerText = `âŒ ä¸Šå‚³å¤±æ•—ï¼š${err.message}`;
    });
}

async function onScanSuccess(decodedText) {
  if (decodedText === lastScanned) return;
  lastScanned = decodedText;
  document.getElementById('result').innerText = `ğŸ“¦ æƒææˆåŠŸï¼š${decodedText}`;
  document.getElementById('loadingText').innerText = "";

  try {
    const res = await fetch(`${scriptUrl}?action=LatestDataFilter&filter=${encodeURIComponent(decodedText)}`);
    const json = await res.json();
    const note = json?.data?.å‚™è¨» || "";
    const date = json?.data?.æ—¥æœŸ || "ç„¡";
    document.getElementById("latestRecord").innerText = `ğŸ“„ ä¸Šæ¬¡ç´€éŒ„ï¼š${date}\nå‚™è¨»ï¼š${note || "ç„¡"}`;
  } catch {
    document.getElementById("latestRecord").innerText = "âŒ ç„¡æ³•å–å¾—ä¸Šæ¬¡ç´€éŒ„";
  }
}

async function onQueryScan(decodedText) {
  if (decodedText === lastScanned) return;
  lastScanned = decodedText;
  document.getElementById("queryLoading").innerText = "ğŸ” æŸ¥è©¢ä¸­...";
  try {
    const res = await fetch(`${scriptUrl}?action=DataFilter&filter=${encodeURIComponent(decodedText)}`);
    const json = await res.json();
    if (!Array.isArray(json.data) || json.data.length === 0) {
      document.getElementById("queryTable").innerHTML = "âš ï¸ æ²’æœ‰æ‰¾åˆ°æ­·å²ç´€éŒ„";
    } else {
      renderQueryTable(json.data);
    }
    document.getElementById("queryLoading").innerText = "";
    setTimeout(() => { lastScanned = ""; }, 3000);
  } catch (err) {
    document.getElementById("queryLoading").innerText = `âŒ æŸ¥è©¢å¤±æ•—ï¼š${err.message}`;
  }
}

function renderQueryTable(data) {
  const targetDiv = document.getElementById("queryTable");
  if (!Array.isArray(data) || data.length === 0) {
    targetDiv.innerHTML = "âš ï¸ æ²’æœ‰è³‡æ–™";
    return;
  }
  if ($.fn.DataTable.isDataTable("#queryDataTable")) {
    $("#queryDataTable").DataTable().destroy();
    $("#queryDataTable").empty();
  }
  let html = `<table id="queryDataTable" class="display"><thead><tr>`;
  data[0].forEach(th => html += `<th>${th}</th>`);
  html += "</tr></thead><tbody>";
  data.slice(1).reverse().forEach(row => {
    html += "<tr>";
    row.forEach(cell => html += `<td>${cell}</td>`);
    html += "</tr>";
  });
  html += "</tbody></table>";
  targetDiv.innerHTML = html;
  $("#queryDataTable").DataTable({
    pageLength: 10,
    language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json" }
  });
}

function switchMode(mode) {
  currentMode = mode;
  if (mode === "scan") {
    document.getElementById("scanSection").style.display = "block";
    document.getElementById("querySection").style.display = "none";
    scanner.render(onScanSuccess);
    scannerQuery.clear();
  } else if (mode === "query") {
    document.getElementById("scanSection").style.display = "none";
    document.getElementById("querySection").style.display = "block";
    scannerQuery.render(onQueryScan);
    scanner.clear();
  }
}

document.addEventListener("DOMContentLoaded", () => {
  loadTags();
  scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: { width: 250, height: 250 } }, false);
  scannerQuery = new Html5QrcodeScanner("readerQuery", { fps: 10, qrbox: { width: 250, height: 250 } }, false);
  scanner.render(onScanSuccess);
});
</script>
</body>
</html>
